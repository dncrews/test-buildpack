#!/bin/bash

# fail fast
set -euxo pipefail

indent() {
  sed -u 's/^/       /'
}

# enter the BUILD_DIR
cd $1

# $3 is the ENV_DIR
ENV_DIR=$3

# Set DO_DEPLOY as the value of the file
[ -f "$ENV_DIR/DO_DEPLOY" ] && export "DO_DEPLOY=$(cat $ENV_DIR/DO_DEPLOY)"

# If there was no file, move along
[ -z "$DO_DEPLOY" ] && exit 0

# If the file contents weren't "1", move along
[ "$DO_DEPLOY" -ne "1" ] && echo "Skipping asset deployment for DO_DEPLOY != '1'" && exit 0

# Need node on the path
PATH=$PATH:$1/vendor/node/bin

# We have what we want
echo "----------> Deploying assets"

echo "NODE_MODULES"
ls ./node_modules
echo "NODE_MODULES/FRONTIER-BUILD-TOOLS"
ls ./node_modules/frontier-build-tools
echo "NODE_MODULES/FRONTIER-BUILD-TOOLS/NODE_MODULES"
ls ./node_modules/frontier-build-tools/node_modules
echo "NODE_MODULES/FRONTIER-BUILD-TOOLS/NODE_MODULES/GULP"
ls ./node_modules/frontier-build-tools/node_modules/gulp
echo "NODE_MODULES/FRONTIER-BUILD-TOOLS/NODE_MODULES/GULP/BIN"
ls ./node_modules/frontier-build-tools/node_modules/gulp/bin

#[ -f "./node_modules/frontier-build-tools/node_modules/.bin/cake" ] && ./node_modules/frontier-build-tools/node_modules/.bin/cake assets:deploy | indent && exit 0
[ -f "./node_modules/frontier-build-tools/node_modules/gulp/bin/gulp.js" ] && ./node_modules/frontier-build-tools/node_modules/gulp/bin/gulp.js dist | indent && exit 0

# If they have their own version of coffee-script, looking in frontier-build-tools will fail
# [ -f "./node_modules/.bin/cake" ] && ./node_modules/.bin/cake assets:deploy | indent && exit 0

# If it didn't exit with the assets deployment, something happened
echo "Something went wrong with the deploy"
exit 1
